name: "DRC and ERC using GitHub actions"

# Controls when the action will run.
on:
  push:
    paths:
      - 'hardware/**/*.kicad_sch'
      - 'hardware/**/*.kicad_pcb'
      - 'hardware/**/*.kibot.yaml'
      - '.github/workflows/*.yml'
  pull_request:
    paths:
      - 'hardware/**/*.kicad_sch'
      - 'hardware/**/*.kicad_pcb'
      - 'hardware/**/*.kibot.yaml'
      - '.github/workflows/*.yml'

jobs:
  ERC_DRC:
    runs-on: ubuntu-latest
    name: ERC and DRC Checks (KiCad 9)

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Find KiCad files
      id: find_files
      working-directory: hardware
      run: |
        SCHEMA_FILE=$(find . -name "*.kicad_sch" -type f | head -n 1)
        PCB_FILE=$(find . -name "*.kicad_pcb" -type f | head -n 1)
        
        if [ -z "$SCHEMA_FILE" ]; then
          echo "Error: No .kicad_sch file found in hardware/"
          exit 1
        fi
        if [ -z "$PCB_FILE" ]; then
          echo "Error: No .kicad_pcb file found in hardware/"
          exit 1
        fi
        
        echo "schema_file=$SCHEMA_FILE" >> $GITHUB_OUTPUT
        echo "pcb_file=$PCB_FILE" >> $GITHUB_OUTPUT
        echo "Found schematic: $SCHEMA_FILE"
        echo "Found PCB: $PCB_FILE"

    - name: Run ERC (Electrical Rule Check)
      uses: actions-for-kicad/kicad-actions@v1-k9.0
      with:
        schematic_file_name: ${{ steps.find_files.outputs.schema_file }}
        run_erc: true
        run_drc: false

    - name: Run DRC (Design Rule Check)
      uses: actions-for-kicad/kicad-actions@v1-k9.0
      with:
        pcb_file_name: ${{ steps.find_files.outputs.pcb_file }}
        run_erc: false
        run_drc: true

    - name: Upload ERC and DRC results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ERC_DRC_Reports
        path: |
          hardware/*.erc
          hardware/*.erc.html
          hardware/*.drc
          hardware/*.drc.html
        retention-days: 7
